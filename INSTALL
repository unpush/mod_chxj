Installing mod_chxj...

1. mod_chxj生成の前に
  1) apache2.0 のヘッダーファイル郡を用意する。
  2) apache2.0用のapxsを用意する。
  3) apr(Apache Portable Runtime)ライブラリとそのヘッダファイル郡を用意する。
  4) automake、autoconf、libtoolを用意する。（動作する状態にする）
  5) ImageMagick

2. mod_chxjインストール手順
※ "$"はプロンプトをあらわします。

  1) Configure スクリプトを生成します。
     $ ./buildconf.sh

  2) Configure
     以下は、/usr/include/apache2.0に、Apache2.0のヘッダーファイルが、
     /usr/include/apr-0に、aprのヘッダーファイルが存在する場合の例です。

     $ ./configure --with-apache-header=/usr/include/apache2.0 \
                 --with-apr-header=/usr/include/apr-0 \
                 --enable-img-conv-f
     と入力します。

     --with-apache-headerと、--with-apr-headerは必須です。
     最後の--enable-img-conv-fは、<img>タグのsrc属性値を変換するように
     指示しています。


  3) mod_chxj.soを生成します
     $ make

  4) apacheにインストールします。
     $ sudo make install
     or
     $ su 
     $ make install

  5) etcディレクトリは以下のdevice_data.xmlとemoji.xmlをApache
     からアクセスできるところに配置します。

     以下、/etc/apache2/chxjディレクトリにchxj用設定ファイルを
     用意する場合

     $ sudo mkdir -p /etc/apache2/chxj
     $ sudo cp etc/device_data.xml /etc/apache2/chxj
     $ sudo cp etc/emoji.xml /etc/apache2/chxj


3. 設定
  以下はmod_chxjが/usr/lib/apache2/modulesディレクトリ配下に設置された
  ものとしています。

  <<htmlファイルが変換対象の場合>>

  例として、Locationが"/chxj"以下のものは全て変換する場合を説明します。

  1) httpd.confに以下を追加します。

     LoadModule chxj_module /usr/lib/apache2/modules/mod_chxj.so
     <Location /chxj>
       SetOutputFilter chxj_output_filter
       SetInputFilter  chxj_input_filter
       ChxjLoadDeviceData  /etc/apache2/chxj/device_data.xml
       ChxjLoadEmojiData   /etc/apache2/chxj/emoji.xml
     </Location>

  2) apacheの再起動。

  <<php等の出力結果が変換対象の場合>>
  1) httpd.confに以下を追加します。

     LoadModule chxj_module /usr/lib/apache2/modules/mod_chxj.so
     <Location /chxj>
       SetOutputFilter chxj_output_filter
       SetInputFilter  chxj_input_filter
       ChxjLoadDeviceData  /etc/apache2/chxj/device_data.xml
       ChxjLoadEmojiData   /etc/apache2/chxj/emoji.xml
     </Location>

  2) apacheの再起動。

  <<mod_jk2を使用したtomcatの出力結果が変換対象の場合>>
  1) httpd.confに以下を追加します。
     input_filterは設定しないでください。

     LoadModule chxj_module /usr/lib/apache2/modules/mod_chxj.so
     <Location /chxj>
       SetOutputFilter chxj_output_filter
       ChxjLoadDeviceData  /etc/apache2/chxj/device_data.xml
       ChxjLoadEmojiData   /etc/apache2/chxj/emoji.xml
     </Location>

   2) chxjfilter-0.0.1.jarを生成します。
      2-1) build.propertiesを環境に合わせて編集します。

      $ cd java
      $ vi build.properties

      2-2) chxjfilter-0.0.1.jarを生成します。
      $ ant dist

      2-3) 生成されたchxjfilter-0.0.1.jarにクラスパスをとおします。
     
   3) web.xmlの編集
      以下を追加します。
      
    <filter>
        <filter-name>chxjfilter</filter-name>
        <filter-class>com.qsdn.filter.CHXJFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>chxjfilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

   4) apache等の再起動


  <<画像自動変換機能を使用する場合>>
  1) httpd.confに以下を追加します。

    ChxjImageUri
    ChxjImageCacheDir
    ChxjImageCopyright

    1-1) ChxjImageUri
      mod_chxjの画像変換ハンドラを起動させたいリクエストＵＲＬのパターンを指定します。
      パターンのルールは、REGEXに基づきます。
 
      ex)
        ChxjImageUri ^/img/*

      URLが /img/ で始まっているリクエストに対してハンドラが起動されます。


    1-2) ChxjImageCacheDir
      mod_chxj画像変換ハンドラが使用する変換後の画像をおいておくディレクトリを指定します。
      デフォルトは/tmp。

      ex)
        ChxjImageCacheDir /tmp

      mod_chxjに画像変換キャッシュとして/tmpを使用するよう指示します。


    1-3) ChxjImageCopyright
      mod_chxjの画像変換ハンドラに、転送禁止設定を行うよう指示します。
      パラメータとして任意の文字列をとります。
      ChxjImageCopyrightディレクティブで指定された文字列は、それぞれのイメージの
      コメント部に埋め込まれます。

      ex)
        ChxjImageCopyright "A.Konno"

       mod_chxjに転送禁止設定を行うよう指示しています。
       変換後イメージのコメント部分には、キャリア毎に以下の文字列を埋め込みます。

       AU の場合
       kddi_copyright=on,A.Konno

       DoCoMoの場合
       copy="NO",A.Konno

       Vodafoneの場合は、レスポンスヘッダに

         x-jphone-copyright:no-transfer

       を埋め込みます。

       ※Vodafoneの場合は、リクエストＵＲＬの最後が.pnzか、.jpzで終わるようにダミーを
       付けなければなりません。
